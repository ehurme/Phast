---
title: "FPT Foraging Sites"
output: html_document
---

Exploring FPT to identify foraging sites

HMM didn't work well when attempting to regularize the data


```{r}
library(pacman)
p_load("momentuHMM", "lubridate", "data.table", "zoo", "move", "dplyr", "adehabitatLT")

source("../../../movebank_login.R")

proj.ll <- CRS('+proj=longlat +datum=WGS84 +no_defs')
projUTM <- CRS("+proj=utm +zone=17 +ellps=GRS80 +datum=NAD83 +units=m +no_defs")
```

```{r}
load("../../../../Dropbox/MPI/Phyllostomus/Fieldwork/Data/results_part1.rdata")
load("../../../../Dropbox/MPI/Phyllostomus/Fieldwork/Data/phastmove.rdata")
inf <- read.delim("../../../../Dropbox/MPI/Phyllostomus/Fieldwork/Data/Greater spear-nosed bat (Phyllostomus hastatus) in Bocas del Toro 2021-2022-reference-data.csv", header=T, sep=',', as.is=T)
```


# Create traj  
```{r}
df <- as.data.frame(phast)
po <- spTransform(SpatialPoints(df[,c("location_long", "location_lat")], proj4string=proj.ll), CRSobj=projUTM)
df$y <- po@coords[,2]
df$x <- po@coords[,1]

df$date <- date(df$timestamp)
df$ID <- paste0(df$local_identifier, "_", df$date)

p.traj <- as.ltraj(data.frame(X = df$x, Y = df$y), date = df$timestamp, id = factor(df$local_identifier), burst = df$ID)
pj <- ld(p.traj)

```

# First Passage Time

```{r}
# Determine Optimal Radius
radii <- seq(15, 300, by = 15)
fpts <- fpt(p.traj, radii, units = "seconds")

varfpt <- varlogfpt(fpts, graph = F)
names(varfpt) <- radii

Radius <- as.numeric(names(which.max(colMeans(as.matrix(varfpt), na.rm = TRUE))))

```

### plot radius
```{r}
boxplot(varfpt, ylab = 'Variance of log(FPT)', xlab = 'Radius (m)', main = paste0("Radius = ", Radius, " m"))
abline(v = which(radii == Radius), col = 2)
```


```{r}
fpt_mean <- colMeans(as.matrix(varfpt), na.rm = TRUE)
fpt_se <- {}
for(i in 1:ncol(varfpt)){
  fpt_se[i] <- sd(varfpt[,i], na.rm = TRUE)# /sqrt(length(na.omit(varfpt[,i])))
}
fpt_rad <- data.frame(fpt_mean, fpt_se, radii)
```

### plot fpt radius
```{r}
p <- ggplot(fpt_rad, aes(x = radii, y = fpt_mean))+geom_line()+ 
  geom_errorbar(aes(ymin=fpt_mean-fpt_se, ymax=fpt_mean+fpt_se), width=30, colour = "black") + 
  geom_line() + theme_classic() + xlab("FPT Radius (m)") + ylab("Mean variance (SD)") +
  geom_segment(aes(x = 0, y = max(colMeans(as.matrix(varfpt), na.rm = TRUE)), xend = Radius, yend = max(colMeans(as.matrix(varfpt), na.rm = TRUE))), linetype = "dashed") +
  geom_segment(aes(x = Radius, y = 0, xend = Radius, yend = max(colMeans(as.matrix(varfpt), na.rm = TRUE))), linetype = "dashed") +
  scale_x_continuous(expand = c(0,0)) + scale_y_continuous(expand = c(0,0)) 
p + theme(plot.margin = unit(c(1,1,1,1), "cm"))
# ggpubr::ggarrange(p + theme(plot.margin = unit(c(1,1,1,1), "cm")), labels = "A")
```

### Determine threshold
```{r}
fpt <- unlist(fpt(p.traj, Radius, units = "seconds"))
logfpts <- na.omit(log(fpt))
mixmdl <- mixtools::normalmixEM(logfpts, k = 3)
plot(mixmdl,which=2)
lines(density(logfpts), lty=2, lwd=2)
abline(v = mixmdl$mu)
idx <- 2#which.min(mixmdl$mu)
#2.58 99% CI
#1.96 95% CI

threshold <- mixmdl$mu[idx]+1.96*mixmdl$sigma[idx]
abline(v = threshold, col = 2, lwd = 2, lty = 2)
exp(threshold)
```

### Match FPT data
```{r}
Bats <- {}
for(i in 1:length(p.traj)){
  # layout(cbind(c(1,2), c(3,4), c(5,6)))
  bat <- ld(p.traj[i])
  bat$bat <- burst(p.traj[i])
  fpts <- unlist(fpt(p.traj[i], Radius))
  bat$FPT <- fpts
  bat$FPT01 <- as.numeric(fpts > exp(threshold))
  Bats <- rbind(Bats, bat)
}

Split <- strsplit(as.character(Bats$bat), "_", fixed = TRUE)
Bats$id <- sapply(Split, "[", 1)

summary(Bats)
# Bats
i = 1
pj$FPT <- NA
pj$FPT01 <- NA
IDX <- {}

for(i in 1:nrow(pj)){
  idx <- which(pj$ID[i] == Bats$bat & pj$date[i] == Bats$date)
  if(length(idx) == 0){
    bidx <- which(pj$ID[i] == Bats$bat)
    times <- abs(difftime(pj$time[i], Bats$date[bidx], units = "sec"))
    
    if(times[which.min(times)] < 15){
      idx <- which.min(times)
    }
    # idx <- which.min(abs(pj$time[bidx] - Bats$date))
  }
  # print(idx)
  IDX <- c(IDX, length(idx))
  if(length(idx)>0){
    pj$FPT[i] <- Bats$FPT[idx]
    pj$FPT01[i] <- Bats$FPT01[idx]  
  }
  
}

# pj$FPT
# summary(pj)
# unique(pj$bat_flight)
```


## Plot FPT data
```{r}

mixmdl_df <- data.frame(x = mixmdl$x)

ggmix <- ggplot(mixmdl_df, aes(x = x)) + 
    geom_histogram(aes(y =..density..),
                   breaks = seq(4, 7, by = .05), 
                   colour = "black", 
                   fill = "white") + 
# stat_function(fun = dnorm, args = list(mean = mixmdl$mu[1], sd = mixmdl$sigma[1]), col = 3)+
  stat_function(fun = dnorm, args = list(mean = mixmdl$mu[2], sd = mixmdl$sigma[2]), col = 2)+
  theme_classic() + geom_vline(xintercept = threshold, cex = 1, linetype = 2) + xlab("ln(FPT)")

#png(filename = "../plots/Seg_Viv_FPT.png", width = 800, height = 600)
ggpubr::ggarrange(p+theme(text = element_text(size=15)), ggmix+theme(text = element_text(size=15)), labels = c("A", "B"), ncol = 2, nrow = 1)
#dev.off()
```
# plot tracks
```{r}
IDs <- unique(Bats$bat)
i = 144

for(i in 1:length(IDs)){
  b <- Bats[Bats$bat == IDs[i],]
  # plot(b$x, b$y, col = b$FPT01+1, 
  #      asp = 1)
  
  p <- ggplot(b[30:100,], aes(x, y, col = FPT))+geom_path()+
    geom_point(aes(size = FPT), shape = 21)+
    viridis::scale_color_viridis()+theme_minimal()
  print(p)
  
  ggplot(b[30:100,], aes(x,y,col = FPT))+geom_tile
  
  levelplot(FPT~x*y, data = b[30:100,], #panel = panel.levelplot.points, 
            cex = 1.2)+  
    layer_(panel.2dsmoother(..., n = 10))
}

```

```{r}
# library
library(latticeExtra) 
 
# create data
set.seed(1) 
data <- data.frame(x = rnorm(100), y = rnorm(100)) 
data$z <- with(data, x * y + rnorm(100, sd = 1)) 
 
# showing data points on the same color scale 
levelplot(z ~ x * y, data, 
          panel = panel.levelplot.points, cex = 1.2
    ) + 
    layer_(panel.2dsmoother(..., n = 200))
```


# identify foraging patches
## get centroids
```{r}
for(i in 1:length(IDs)){
  b <- Bats[Bats$bat == IDs[i],]
  
  spline(b$FPT, n = 20) %>% plot(type = "l")
  patches <- rle(b$FPT01)
  hist(patches$lengths[patches$values == 1], breaks = 20)
  
  plot(b$FPT, type = "o")
}
```

```{r}
library(mapview)

mapview(breweries, zcol = "founded", at = seq(1400, 2200, 200), legend = TRUE)
breweries %>% is
breweries %>% str
```

```{r}
Bats$geometry <- sf::as_Spatial()
```


```{r}
save(Bats, )
```

